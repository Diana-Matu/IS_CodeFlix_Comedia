---
import CardMovie from "./CardMovie.astro";
import { getComedyMovies } from "../services/movies";

// SSR inicial por si NO vienen par√°metros en la URL:
const initialMovies = await getComedyMovies();
---

<section class="movies-section">
  <div class="container">

    <div class="controls">
      <form id="search-form" class="search-bar" on:submit="return false;">
        <input id="search-input" type="text" placeholder="Buscar pel√≠cula o serie..." />
        <button id="search-button" type="button">üîç Buscar</button>
      </form>

      <div class="filters">
        <select id="filter-select" aria-label="Filtros">
          <option value="comedy-movies">üé¨ Pel√≠culas de comedia</option>
          <option value="comedy-series">üì∫ Series de comedia</option>
          <option value="all">üåç Todos los g√©neros</option>
          <option value="movies-all">üéûÔ∏è Pel√≠culas (todos los g√©neros)</option>
          <option value="series-all">üì∫ Series (todos los g√©neros)</option>
        </select>
      </div>
    </div>

    <div id="status" class="status" role="status" aria-live="polite"></div>

    <div id="movies-grid" class="movies-grid">
      {initialMovies.map(movie => (
        <CardMovie movie={movie} filter="comedy-movies" query="" />
      ))}
    </div>

  </div>
</section>

<script type="module" is:inline>
  window.addEventListener("DOMContentLoaded", () => {
    console.log("%c[Movies] client script starting", "color: #8ef");

    const moviesGrid = document.getElementById("movies-grid");
    const statusEl = document.getElementById("status");
    const searchInput = document.getElementById("search-input");
    const searchBtn = document.getElementById("search-button");
    const filterSel = document.getElementById("filter-select");

    function setStatus(msg) {
      statusEl.textContent = msg;
      console.log("[Movies] status:", msg);
    }

    // Leer params actuales de la URL
    const url = new URL(window.location.href);
    const initialFilter = url.searchParams.get("filter") || "comedy-movies";
    const initialQuery = url.searchParams.get("query") || "";

    console.log("[Movies] initialFilter:", initialFilter, "initialQuery:", initialQuery);
    filterSel.value = initialFilter;
    searchInput.value = initialQuery;

    async function fetchAndRender({ filter = "comedy-movies", query = "" } = {}) {
      setStatus("Cargando...");
      console.log("[Movies] fetchAndRender ->", { filter, query });

      try {
        const qs = new URLSearchParams();
        qs.set("filter", filter);
        if (query) qs.set("query", query);
        const apiUrl = `/api/movies?${qs.toString()}`;

        console.log("[Movies] fetching", apiUrl);
        const res = await fetch(apiUrl);
        console.log("[Movies] response status", res.status);

        // Mostrar cabeceras relevantes (si existen)
        const debugHeaders = {
          "x-tmdb-endpoint": res.headers.get("x-tmdb-endpoint"),
          "x-received-filter": res.headers.get("x-received-filter"),
          "content-type": res.headers.get("content-type")
        };
        console.log("[Movies] response headers:", debugHeaders);
        setStatus(`Consultando API... Status ${res.status}. Endpoint: ${debugHeaders["x-tmdb-endpoint"] || 'n/a'}`);

        const text = await res.text();
        let data;
        try {
          data = JSON.parse(text);
        } catch (err) {
          console.error("[Movies] JSON parse error", err);
          setStatus("Respuesta no JSON de la API ‚Äî abre Network/Response para ver detalles.");
          moviesGrid.innerHTML = `<pre style="color:#f88; padding:1rem; background:#111;">${text}</pre>`;
          return;
        }

        // Si la API env√≠a { error: "..."} lo mostramos
        if (data && data.error) {
          console.warn("[Movies] API returned error object:", data.error);
          setStatus("API devolvi√≥ error: " + data.error);
          moviesGrid.innerHTML = `<pre style="color:#f88; padding:1rem; background:#111;">${JSON.stringify(data, null, 2)}</pre>`;
          return;
        }

        // TMDB devuelve normalmente un array; si viene dentro de .results, servidor ya lo normaliza.
        const list = Array.isArray(data) ? data.slice(0, 24) : [];

        setStatus(list.length ? `Mostrando ${list.length} resultados.` : "No se encontraron resultados.");
        renderMovies(list);

      } catch (err) {
        console.error("[Movies] fetch error:", err);
        setStatus("Error al consultar /api/movies ‚Äî comprueba consola y Network.");
      }
    }

    function clearGrid() {
      moviesGrid.innerHTML = "";
    }

    function renderMovies(movies) {
      clearGrid();
      if (!movies || movies.length === 0) {
        // Si no hay resultados, mostrar SSR (para comparar)
        const ssrHint = document.createElement("div");
        ssrHint.style.padding = "1rem";
        ssrHint.style.color = "#ddd";
        ssrHint.innerHTML = "<strong>No hay resultados en la b√∫squeda actual.</strong>";
        moviesGrid.appendChild(ssrHint);
        return;
      }

      for (const m of movies) {
        const link = document.createElement("a");
        link.className = "card";
        link.href = `/movies/${m.id}?filter=${filterSel.value}&query=${searchInput.value.trim()}`;

        const img = document.createElement("img");
        img.loading = "lazy";
        img.alt = m.title ?? m.name ?? "Untitled";
        img.src = m.poster_path
          ? `https://image.tmdb.org/t/p/w500${m.poster_path}`
          : `https://via.placeholder.com/500x750?text=No+Image`;
        img.className = "card-img";

        link.appendChild(img);

        const header = document.createElement("div");
        header.className = "card-info";

        const h2 = document.createElement("h2");
        h2.className = "title";
        h2.textContent = m.title ?? m.name ?? "Untitled";
        header.appendChild(h2);

        const p = document.createElement("p");
        p.className = "rating";
        p.textContent = `‚≠ê ${m.vote_average ?? "‚Äî"} ‚Ä¢ ${m.release_date ?? m.first_air_date ?? ""}`;
        header.appendChild(p);

        if (m.overview) {
          const ov = document.createElement("p");
          ov.className = "overview";
          ov.textContent = m.overview;
          header.appendChild(ov);
        }

        link.appendChild(header);
        moviesGrid.appendChild(link);
      }
    }

    // Eventos
    searchBtn.addEventListener("click", () => {
      const q = searchInput.value.trim();
      history.replaceState({}, "", `/?filter=${filterSel.value}&query=${q}`);
      fetchAndRender({ filter: filterSel.value, query: q });
    });

    searchInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        searchBtn.click();
      }
    });

    filterSel.addEventListener("change", () => {
      const q = searchInput.value.trim();
      history.replaceState({}, "", `/?filter=${filterSel.value}&query=${q}`);
      fetchAndRender({ filter: filterSel.value, query: q });
    });

    // Ejecuci√≥n inicial
    fetchAndRender({ filter: initialFilter, query: initialQuery });
  });
</script>

<style>
:root { --yellow: #ffea00; --bg: #0a0a09; --muted: #aaa; }
.movies-section { background: var(--bg); color: var(--yellow); padding: 2rem 1rem; min-height: 60vh; }
.container { max-width: 1200px; margin: 0 auto; }

.controls { display:flex; gap:1rem; justify-content: center; align-items: center; margin-bottom:1rem; flex-wrap:wrap; }
.search-bar { display:flex; gap: .5rem; background:#111; padding: .4rem; border-radius:9999px; align-items:center; }
.search-bar input { background: none; border: none; color: #fff; padding: .6rem .8rem; outline:none; width:320px; max-width:60vw; }
.search-bar button { background: var(--yellow); color: #000; border:none; padding:.5rem 1rem; border-radius:9999px; font-weight:700; cursor:pointer; }

.filters select { background:#000; color:var(--yellow); border:2px solid var(--yellow); padding:.5rem .9rem; border-radius:12px; }

.status { color: #ddd; text-align:center; margin-bottom:1rem; min-height:2.2rem; }

/* grid y cards (igual que antes) */
.movies-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 1.5rem;
}
@media (max-width:1200px) { .movies-grid { grid-template-columns: repeat(3,1fr); } }
@media (max-width:900px) { .movies-grid { grid-template-columns: repeat(2,1fr); } }
@media (max-width:600px) { .movies-grid { grid-template-columns: 1fr; } }
</style>

<style is:global>
.card { display:flex; flex-direction:column; background:#000; color:#fff; border-radius:12px; overflow:hidden; text-decoration:none; transition:transform .25s; }
.card-img, .card img { width:100%; height:340px; object-fit:cover; display:block; }
.card-info { padding:.8rem; text-align:center; }
.title{ color: #ffea00; font-weight:700; }
.rating{ color:#ddd; }
.overview{ color:#aaa; font-size:.85rem; line-height:1.2; max-height:3.6em; overflow:hidden; }
</style>
