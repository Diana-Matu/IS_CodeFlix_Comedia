---
// src/components/Movies.astro
import CardMovie from "./CardMovie.astro";
// Nota: no hacemos fetch de comedia en SSR, dejamos que el cliente cargue el dato y restaure estado
import type { Movie } from "../services/movies";
const initialMovies: Movie[] = []; // SSR vac√≠o para evitar "sesgo comedia"
---

<section class="movies-section">
  <div class="container">

    <div class="controls">
      <form id="search-form" class="search-bar" on:submit="return false;">
        <input id="search-input" type="text" placeholder="Buscar pel√≠cula o serie..." />
        <button id="search-button" type="button">üîç Buscar</button>
      </form>

      <div class="filters">
        <select id="filter-select" aria-label="Filtros">
          <option value="comedy-movies">üé¨ Pel√≠culas de comedia</option>
          <option value="comedy-series">üì∫ Series de comedia</option>
          <option value="all">üåç Todos los g√©neros</option>
          <option value="movies-all">üéûÔ∏è Pel√≠culas (todos los g√©neros)</option>
          <option value="series-all">üì∫ Series (todos los g√©neros)</option>
        </select>
      </div>
    </div>

    <div id="status" class="status" role="status" aria-live="polite"></div>

    <div id="movies-grid" class="movies-grid">
      <!-- Si quieres mostrar algo SSR puedes mapear initialMovies aqu√≠,
           ahora est√° vac√≠o para dejar l√≥gica al cliente -->
      {initialMovies.map(movie => <CardMovie movie={movie} />)}
    </div>

  </div>
</section>

<script type="module" is:inline>
  console.log("Movies client script loaded");

  const moviesGrid = document.getElementById("movies-grid");
  const statusEl = document.getElementById("status");
  const searchInput = document.getElementById("search-input");
  const searchBtn = document.getElementById("search-button");
  const filterSel = document.getElementById("filter-select");

  if (!moviesGrid || !statusEl || !searchInput || !searchBtn || !filterSel) {
    console.error("Movies script: alguno de los elementos no existe.", { moviesGrid, statusEl, searchInput, searchBtn, filterSel });
  }

  function setStatus(msg) {
    statusEl.textContent = msg;
  }

  async function fetchAndRender({ filter = "comedy-movies", query = "" } = {}) {
    setStatus("Cargando...");
    try {
      const qs = new URLSearchParams();
      qs.set("filter", filter ?? "");
      if (query) qs.set("query", query);

      console.log("‚Üí Fetching /api/movies with QS:", qs.toString());

      const res = await fetch(`/api/movies?${qs.toString()}`);
      const usedEndpoint = res.headers.get("X-TMDB-ENDPOINT");
      console.log("Response X-TMDB-ENDPOINT:", usedEndpoint);

      if (!res.ok) {
        const txt = await res.text();
        console.error("API error:", res.status, txt);
        throw new Error("API error");
      }
      const data = await res.json();

      console.log("API returned", Array.isArray(data) ? data.length : "?", "items; sample ids:", (Array.isArray(data) ? data.slice(0,3).map(x=>x.id) : data));

      renderMovies(Array.isArray(data) ? data : []);
      setStatus(data.length ? "" : "No se encontraron resultados.");
    } catch (err) {
      console.error(err);
      setStatus("Error cargando pel√≠culas.");
    }
  }

  function clearGrid() { if (moviesGrid) moviesGrid.innerHTML = ""; }

  // Unificamos el DOM que se genera con las clases del CSS global
  function renderMovies(movies) {
    if (!moviesGrid) return;
    clearGrid();
    const list = movies.slice(0, 24);
    for (const m of list) {
      const link = document.createElement("a");
      link.className = "card";
      link.href = `/movies/${m.id}`;

      // Card image wrapper
      const imgWrap = document.createElement("div");
      imgWrap.className = "card-img";
      const img = document.createElement("img");
      img.loading = "lazy";
      img.alt = m.title ?? m.name ?? "Untitled";
      img.src = m.poster_path ? `https://image.tmdb.org/t/p/w500${m.poster_path}` : "https://via.placeholder.com/500x750?text=No+Image";
      imgWrap.appendChild(img);
      link.appendChild(imgWrap);

      const header = document.createElement("header");
      header.className = "card-info";

      const h2 = document.createElement("h2");
      h2.className = "title";
      h2.textContent = m.title ?? m.name ?? "Untitled";
      header.appendChild(h2);

      const p = document.createElement("p");
      p.className = "rating";
      p.textContent = `‚≠ê ${m.vote_average ?? "‚Äî"} ‚Ä¢ ${m.release_date ?? m.first_air_date ?? ""}`;
      header.appendChild(p);

      if (m.overview) {
        const ov = document.createElement("p");
        ov.className = "overview";
        ov.textContent = m.overview;
        header.appendChild(ov);
      }

      link.appendChild(header);
      moviesGrid.appendChild(link);
    }
  }

  // --- Persistencia simple: sessionStorage ---
  function saveState() {
    try {
      sessionStorage.setItem("filter", filterSel.value);
      sessionStorage.setItem("query", searchInput.value.trim());
    } catch (e) { /* ignore */ }
  }

  // Restaurar estado al cargar
  const restoredFilter = (sessionStorage.getItem("filter")) || "comedy-movies";
  const restoredQuery = (sessionStorage.getItem("query")) || "";

  // Aplicar al DOM
  filterSel.value = restoredFilter;
  searchInput.value = restoredQuery;

  // Cargar datos iniciales desde cliente (restaurando lo que hab√≠a en sessionStorage)
  fetchAndRender({ filter: restoredFilter, query: restoredQuery });

  // Event listeners
  searchBtn?.addEventListener("click", () => {
    const q = searchInput.value.trim();
    saveState();
    fetchAndRender({ filter: filterSel.value, query: q });
  });

  searchInput?.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      searchBtn.click();
    }
  });

  filterSel?.addEventListener("change", () => {
    const q = searchInput.value.trim();
    saveState();
    fetchAndRender({ filter: filterSel.value, query: q });
  });
</script>

<style>
:root { --yellow: #ffea00; --bg: #0a0a09; --muted: #aaa; }
.movies-section { background: var(--bg); color: var(--yellow); padding: 2rem 1rem; min-height: 60vh; }
.container { max-width: 1200px; margin: 0 auto; }

.controls { display:flex; gap:1rem; justify-content: center; align-items: center; margin-bottom:1rem; flex-wrap:wrap; }
.search-bar { display:flex; gap: .5rem; background:#111; padding: .4rem; border-radius:9999px; align-items:center; }
.search-bar input { background: none; border: none; color: #fff; padding: .6rem .8rem; outline:none; width:320px; max-width:60vw; }
.search-bar button { background: var(--yellow); color: #000; border:none; padding:.5rem 1rem; border-radius:9999px; font-weight:700; cursor:pointer; }

.filters select { background:#000; color:var(--yellow); border:2px solid var(--yellow); padding:.5rem .9rem; border-radius:12px; }

.status { color: #ddd; text-align:center; margin-bottom:1rem; min-height:1.2rem; }

.movies-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 1.5rem;
}
@media (max-width:1200px) { .movies-grid { grid-template-columns: repeat(3,1fr); } }
@media (max-width:900px) { .movies-grid { grid-template-columns: repeat(2,1fr); } }
@media (max-width:600px) { .movies-grid { grid-template-columns: 1fr; } }

/* Nota: las clases .card y sus hijos ya est√°n en Layout.astro (global) */
</style>
